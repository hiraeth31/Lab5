using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System;
using System.Collections.Generic;
using System.Linq; // Понадобится для .Contains() и .Any()
using System.Text.Json; // Для работы с JSON в сессии
// using System.Threading.Tasks; // Не нужен, если OnPostToggleFavoriteArticle не async

namespace Lab5.Pages
{
    public class ArticleDetailsModel : PageModel
    {
        [TempData]
        public bool FavoriteStateChanged { get; set; } // Флаг для JavaScript

        public ArticleData? CurrentArticle { get; private set; }

        // Свойство для отслеживания, находится ли текущая статья в избранном
        public bool IsCurrentArticleFavorite { get; private set; }

        // Ключ для хранения списка ID избранных статей в сессии
        private const string SessionKeyFavoriteArticles = "FavoriteArticleIdsList";

        public IActionResult OnGet(int? id)
        {
            if (id == null)
            {
                return NotFound("Статья не найдена: ID не указан.");
            }
            LoadArticleById(id.Value);
            if (CurrentArticle == null)
            {
                return NotFound($"Статья с ID {id} не найдена.");
            }

            // Проверяем, находится ли текущая статья в избранном
            IsCurrentArticleFavorite = CheckIfArticleIsFavorite(id.Value);

            ViewData["Title"] = CurrentArticle.Title;
            return Page();
        }

        // Обработчик для добавления/удаления статьи из избранного
        public IActionResult OnPostToggleFavoriteArticle(int articleId) // articleId будет передан из формы
        {
            if (User.Identity == null || !User.Identity.IsAuthenticated)
            {
                // Если пользователь не авторизован, перенаправляем на страницу входа
                // Сохраняем текущий URL статьи, чтобы вернуться сюда после входа
                string returnUrl = Url.Page("/ArticleDetails", new { id = articleId });
                return RedirectToPage("/Login", new { ReturnUrl = returnUrl });
            }

            var favoriteIds = GetFavoriteArticleIdsFromSession();

            if (favoriteIds.Contains(articleId))
            {
                favoriteIds.Remove(articleId); // Удаляем из избранного
            }
            else
            {
                favoriteIds.Add(articleId); // Добавляем в избранное
            }

            SaveFavoriteArticleIdsToSession(favoriteIds);

            FavoriteStateChanged = true;

            // Перенаправляем обратно на ту же страницу статьи, чтобы обновить UI (иконку закладки)
            return RedirectToPage(new { id = articleId });
        }


        // Твой существующий метод загрузки статей
        private void LoadArticleById(int articleId)
        {
            if (articleId == 1)
            {
                CurrentArticle = new ArticleData
                {
                    Id = 1,
                    Title = "Вам трудно вести сложные разговоры?",
                    ImagePath = "/images/article_1.png",
                    PublishDate = new DateTime(2025, 3, 2),
                    Content = @"
                    <p>Правильное общение имеет решающее значение, если вы стремитесь к здоровым отношениям. И это актуально как с личной, так и с профессиональной точки зрения. Хотя некоторые разговоры начинать легко, другие требуют смелости, конфронтации или откровенного подхода. Именно в таких случаях важную роль играет «трудный разговор». Он необходим, когда ставки высоки, а честность не подлежит обсуждению.</p>
                    <h3>Способствует подлинности</h3>
                    <p>Трудные разговоры играют ключевую роль, если вы стремитесь к подлинным отношениям. Зачастую мы склонны избегать неудобных бесед, которые имеют решающее значение для наших отношений, и в результате сталкиваемся с недопониманием и обидой. Однако, если вы выберете сложный путь и затронете эти вопросы, вы и ваш партнёр получите ясность и взаимное уважение.</p>
                    <h3>Стимулирует рост</h3>
                    <p>Трудные разговоры побуждают вас столкнуться со своими страхами, предположениями, убеждениями и поведением. В целом, они помогают вам преодолеть страхи, которые часто мешают вашему развитию. В такие моменты вы вдохновляетесь выйти из зоны комфорта, что приводит к профессиональному и личностному росту.</p>
                    <h3>Укрепляет доверие</h3>
                    <p>Хотя трудные разговоры могут быть некомфортными, они способны положительно повлиять на доверие. Да, вы не ослышались. Однако для этого необходимо подходить к таким беседам с честностью и уважением. Не говоря уже о том, что обе стороны должны быть готовы вкладываться в отношения и работать над ними. В результате вы укрепите доверие, которое поможет вам общаться более открыто.</p>
                    <h3>Решает скрытые проблемы</h3>
                    <p>Нерешённые проблемы, какими бы незначительными они ни казались, со временем могут перерасти в серьёзные трудности. Поэтому, будь то личный или рабочий вопрос, обязательно решайте его соответствующим образом. Помните, что избегание проблемы не означает её решения. Благодаря трудным разговорам вы можете поднять такие вопросы на поверхность и разобраться с ними раз и навсегда.</p>
                    <h3>Как это сделать:</h3>
                    <p>Готовы начать трудный разговор, но не знаете, с чего начать? Мы поможем вам. Просто следуйте этим советам:</p>
                    <p><strong>Будьте ясны на этапе подготовки</strong><br>Перед тем как начать разговор, убедитесь, что у вас есть конкретная цель, которую вы хотите достичь. Это поможет вам определить правильные шаги или понять, как действовать, если ситуация не пойдёт по вашему плану. Задайте себе вопросы: чего вы пытаетесь добиться? Как вы планируете оставаться сосредоточенным на своей цели? Благодаря тщательной подготовке вы сможете заранее справиться со своими эмоциями и не дать им вмешаться в разговор.</p>
                    <p><strong>Выберите подходящее время и место</strong><br>Помните, что контекст играет важную роль в трудных разговорах. Он задаёт тон беседы. Поэтому выберите время и место, которые позволят обеим сторонам чувствовать себя спокойно и быть готовыми к продуктивному разговору. В качестве подсказки: если разговор касается чувствительных тем, выберите уединённое место. Также убедитесь, что обстановка нейтральна, чтобы создать ощущение открытости и безопасности.</p>
                    <p><strong>Используйте активное слушание</strong><br>Слушайте больше, говорите меньше. Помните, что трудный разговор — это общение двух сторон. И так же, как вы хотите быть услышанным, другая сторона ожидает такого же уважения. Дайте собеседнику время поделиться своими мыслями, признайте его эмоции и избегайте перебиваний. Благодаря активному слушанию вероятность конфронтации снизится, даже если в итоге вы не придёте к согласию.</p>
                    <p><strong>Оставайтесь уважительным и спокойным</strong><br>Нельзя исключить эмоции во время трудных разговоров. Более того, есть вероятность, что они будут накаляться и захотят взять верх над беседой. Поэтому всеми силами старайтесь избегать личных нападок и потери самообладания. Вместо этого сосредоточьтесь на самой проблеме, а не на человеке или людях, с которыми вы ведёте этот разговор.</p>
                    <p><strong>Предложите решения</strong><br>В конце разговора предлагайте решения, а не критику или обвинения. Вы можете предложить возможные варианты и даже предложить сотрудничество в их реализации. Также проявите такое же уважение к своему собеседнику. Если у него есть возможное решение, предложите помощь вместо того, чтобы критиковать его.</p>
                    <p><strong>Следите за выполнением</strong><br>После того как вы договорились о возможных решениях, разговор на этом не заканчивается. Каждая сторона должна следить за тем, чтобы согласованное решение реализовывалось. Последующие действия показывают вашу приверженность окончательному решению проблемы.</p>
                    <h3>Заключение</h3>
                    <p>Хотя трудные разговоры обещают большие результаты, это не так просто, как кажется. Они могут быть некомфортными, особенно если вы делаете это впервые. Но даже в этом случае всегда важно сосредотачиваться на преимуществах, которые часто перевешивают трудности начала такого разговора. В личной жизни это позволяет вам укрепить связи, завоевать взаимное уважение, доверие и близость. На профессиональном уровне, с другой стороны, это способствует формированию культуры прозрачности и ответственности.</p>
                    "
                };
            }
            else if (articleId == 2)
            {
                CurrentArticle = new ArticleData
                {
                    Id = 2,
                    Title = "Что такое синдром самозванца: связан ли он с личностью?",
                    ImagePath = "/images/article_2.png",
                    PublishDate = new DateTime(2025, 3, 1),
                    Content = @"
                    <p>Правильное общение имеет решающее значение, если вы стремитесь к здоровым отношениям. И это актуально как с личной, так и с профессиональной точки зрения. Хотя некоторые разговоры начинать легко, другие требуют смелости, конфронтации или откровенного подхода. Именно в таких случаях важную роль играет «трудный разговор». Он необходим, когда ставки высоки, а честность не подлежит обсуждению.</p>
                    <h3>Способствует подлинности</h3>
                    <p>Трудные разговоры играют ключевую роль, если вы стремитесь к подлинным отношениям. Зачастую мы склонны избегать неудобных бесед, которые имеют решающее значение для наших отношений, и в результате сталкиваемся с недопониманием и обидой. Однако, если вы выберете сложный путь и затронете эти вопросы, вы и ваш партнёр получите ясность и взаимное уважение.</p>
                    <h3>Стимулирует рост</h3>
                    <p>Трудные разговоры побуждают вас столкнуться со своими страхами, предположениями, убеждениями и поведением. В целом, они помогают вам преодолеть страхи, которые часто мешают вашему развитию. В такие моменты вы вдохновляетесь выйти из зоны комфорта, что приводит к профессиональному и личностному росту.</p>
                    <h3>Укрепляет доверие</h3>
                    <p>Хотя трудные разговоры могут быть некомфортными, они способны положительно повлиять на доверие. Да, вы не ослышались. Однако для этого необходимо подходить к таким беседам с честностью и уважением. Не говоря уже о том, что обе стороны должны быть готовы вкладываться в отношения и работать над ними. В результате вы укрепите доверие, которое поможет вам общаться более открыто.</p>
                    <h3>Решает скрытые проблемы</h3>
                    <p>Нерешённые проблемы, какими бы незначительными они ни казались, со временем могут перерасти в серьёзные трудности. Поэтому, будь то личный или рабочий вопрос, обязательно решайте его соответствующим образом. Помните, что избегание проблемы не означает её решения. Благодаря трудным разговорам вы можете поднять такие вопросы на поверхность и разобраться с ними раз и навсегда.</p>
                    <h3>Как это сделать:</h3>
                    <p>Готовы начать трудный разговор, но не знаете, с чего начать? Мы поможем вам. Просто следуйте этим советам:</p>
                    <p><strong>Будьте ясны на этапе подготовки</strong><br>Перед тем как начать разговор, убедитесь, что у вас есть конкретная цель, которую вы хотите достичь. Это поможет вам определить правильные шаги или понять, как действовать, если ситуация не пойдёт по вашему плану. Задайте себе вопросы: чего вы пытаетесь добиться? Как вы планируете оставаться сосредоточенным на своей цели? Благодаря тщательной подготовке вы сможете заранее справиться со своими эмоциями и не дать им вмешаться в разговор.</p>
                    <p><strong>Выберите подходящее время и место</strong><br>Помните, что контекст играет важную роль в трудных разговорах. Он задаёт тон беседы. Поэтому выберите время и место, которые позволят обеим сторонам чувствовать себя спокойно и быть готовыми к продуктивному разговору. В качестве подсказки: если разговор касается чувствительных тем, выберите уединённое место. Также убедитесь, что обстановка нейтральна, чтобы создать ощущение открытости и безопасности.</p>
                    <p><strong>Используйте активное слушание</strong><br>Слушайте больше, говорите меньше. Помните, что трудный разговор — это общение двух сторон. И так же, как вы хотите быть услышанным, другая сторона ожидает такого же уважения. Дайте собеседнику время поделиться своими мыслями, признайте его эмоции и избегайте перебиваний. Благодаря активному слушанию вероятность конфронтации снизится, даже если в итоге вы не придёте к согласию.</p>
                    <p><strong>Оставайтесь уважительным и спокойным</strong><br>Нельзя исключить эмоции во время трудных разговоров. Более того, есть вероятность, что они будут накаляться и захотят взять верх над беседой. Поэтому всеми силами старайтесь избегать личных нападок и потери самообладания. Вместо этого сосредоточьтесь на самой проблеме, а не на человеке или людях, с которыми вы ведёте этот разговор.</p>
                    <p><strong>Предложите решения</strong><br>В конце разговора предлагайте решения, а не критику или обвинения. Вы можете предложить возможные варианты и даже предложить сотрудничество в их реализации. Также проявите такое же уважение к своему собеседнику. Если у него есть возможное решение, предложите помощь вместо того, чтобы критиковать его.</p>
                    <p><strong>Следите за выполнением</strong><br>После того как вы договорились о возможных решениях, разговор на этом не заканчивается. Каждая сторона должна следить за тем, чтобы согласованное решение реализовывалось. Последующие действия показывают вашу приверженность окончательному решению проблемы.</p>
                    <h3>Заключение</h3>
                    <p>Хотя трудные разговоры обещают большие результаты, это не так просто, как кажется. Они могут быть некомфортными, особенно если вы делаете это впервые. Но даже в этом случае всегда важно сосредотачиваться на преимуществах, которые часто перевешивают трудности начала такого разговора. В личной жизни это позволяет вам укрепить связи, завоевать взаимное уважение, доверие и близость. На профессиональном уровне, с другой стороны, это способствует формированию культуры прозрачности и ответственности.</p>
                    "
                };
            }
        }

        // --- Методы для работы с избранным в сессии ---
        private List<int> GetFavoriteArticleIdsFromSession()
        {
            var json = HttpContext.Session.GetString(SessionKeyFavoriteArticles);
            if (string.IsNullOrEmpty(json))
            {
                return new List<int>();
            }
            try
            {
                // Пытаемся десериализовать. Если не получится, возвращаем пустой список.
                return JsonSerializer.Deserialize<List<int>>(json) ?? new List<int>();
            }
            catch (JsonException)
            {
                // В случае ошибки парсинга (например, если данные в сессии повреждены)
                // лучше вернуть пустой список и, возможно, очистить ключ сессии.
                HttpContext.Session.Remove(SessionKeyFavoriteArticles);
                return new List<int>();
            }
        }

        private void SaveFavoriteArticleIdsToSession(List<int> ids)
        {
            var json = JsonSerializer.Serialize(ids);
            HttpContext.Session.SetString(SessionKeyFavoriteArticles, json);
        }

        private bool CheckIfArticleIsFavorite(int articleId)
        {
            var favoriteIds = GetFavoriteArticleIdsFromSession();
            return favoriteIds.Contains(articleId);
        }
    }

    // Твой существующий класс ArticleData - без изменений
    public class ArticleData
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public string ImagePath { get; set; } = string.Empty;
        public DateTime PublishDate { get; set; }
        public string Content { get; set; } = string.Empty;
    }
}